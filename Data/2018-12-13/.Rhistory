intToBits(dat$timestamp_16[idxhr][1])
length(intToBits(dat$timestamp_16[idxhr][1]))
showBits(dat$timestamp_16[idxhr][1])
intToBits(dat$timestamp_16[idxhr][1])
intToBits(dat$timestamp_16[idxhr][3])
intToBits(dat$timestamp_16[idxhr][4])
intToBits(dat$timestamp_16[idxhr][5])
intToBits(dat$timestamp_16[idxhr][6])
intToBits(dat$timestamp_16[idxhr][7])
intToBits(dat$timestamp_16[idxhr][10])
intToBits(dat$timestamp[10])
intToBits(dat$timestamp[9])
intToBits(dat$timestamp[9])+intToBits(dat$timestamp_16[idxhr][7])
dat$timestamp
which(dat$timestamp)
# plot
plot(dat$timestamp_16[idxhr]/(60*60)+4,dat$heart_rate[idxhr],type='l',
xlab="Timestamp-16")
intToBits(dat$timestamp_16[idxhr][1])
intToBits(dat$timestamp_16[idxhr][1])[1]
intToBits(dat$timestamp_16[idxhr][1])[1:16]
intToBits(dat$timestamp_16[idxhr][1])[1:32]
intToBits(dat$timestamp_16[idxhr][1])[1:33]
intToBits(dat$timestamp_16[idxhr][1])[1:50]
intToBits(dat$timestamp_16[idxhr][1])[1:16]
as.double(intToBits(dat$timestamp_16[idxhr][1])[1:16])
intToBits(dat$timestamp_16[idxhr][1])[1:16]
intToBits(dat$timestamp_16[idxhr][1])[1:16]+10
as.numeric(intToBits(dat$timestamp_16[idxhr][1])[1:16])
intToBits(dat$timestamp_16[idxhr][1])[1:16]
install.packages("binaryLogic",dependencies = TRUE)
library(binaryLogic)
as.binary(10)
as.binary(20)
as.binary(dat$timestamp)
dat$timestamp
setwd("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/")
# dir() # does return all the fit files...
# for each date in the data folder
dat=c()
dates = dir()
idx = 0
for(di in dates)
files = dir(paste("./",di,sep="")) # get .fit files
setwd(paste("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/",di,sep=""))
# for each file in the date directory
for (fi in files){
fi
idx = idx+1
tmpdat=read.fit(fi)$monitoring
cond=read.fit(fi)$monitoring$heart_rate
if(!is.null(cond)){
# fill in NAs for missing columns
dat[   setdiff(names(tmpdat), names(dat))]<- NA
tmpdat[setdiff(names(dat), names(tmpdat))]<- NA
# concatinate
dat=rbind(dat,tmpdat)
}
}
# get heart rate indecies
idxhr= !is.na(dat$heart_rate)
# garmin timestamp and timestamp_16 are mutually exclusive;
all(is.na(dat$timestamp[-1])==!is.na(dat$timestamp_16[-1]))
# ^ values that are NA in one are not NA in the other
# garmin time is seconds since Dec 31, 1989,
# to convert to standard unix time since 1970 epoch, add 631065600
# or just set origin accordingly;
as.binary(dat$timestamp)
?as.binary
as.binary(dat$timestamp_16)
as.binary(dat$timestamp_16[idxhr])
as.binary(dat$timestamp[!idxhr])
any(is.na(dat$timestamp[!idxhr]))
dat$timestamp[!idxhr]
as.binary(dat$timestamp[!is.na(dat$timestamp)])
as.binary(dat$timestamp_16[idxhr])
as.numeric(as.binary(dat$timestamp_16[idxhr]))
as.numeric(as.binary(dat$timestamp_16[idxhr])[[1]])
dat$timestamp_16[idxhr][1]
dat
dat$timestamp
dat$timestamp
# garmin time is seconds since Dec 31, 1989,
# to convert to standard unix time since 1970 epoch, add 631065600
# or just set origin accordingly;
dat$timestamp=as.POSIXct(dat$timestamp,tz="UTC",origin="1989-12-01")
as.binary(dat$timestamp[!is.na(dat$timestamp)])
tmp=dat$timestamp
tmp[!is.na(dat$timestamp)]=as.binary(dat$timestamp[!is.na(dat$timestamp)])
tmp[!is.na(dat$timestamp)]=unlist(as.binary(dat$timestamp[!is.na(dat$timestamp)]))
unlist(as.binary(dat$timestamp[!is.na(dat$timestamp)]))
(as.binary(dat$timestamp[!is.na(dat$timestamp)]))
as.binary(0*FFFF)
as.binary(0xFFFF)
dat$timestamp[!is.na(dat$timestamp)]
as.binary(dat$timestamp[!is.na(dat$timestamp)])
as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]
as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]-as.binary(0xFFFF)
as.numeric(as.binary(0xFFFF))
as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]*as.binary(0xFFFF)
as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF)
as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]
as.binary(dat$timestamp[!is.na(dat$timestamp)])
as.binary(dat$timestamp_16[is.na(dat$timestamp)])
as.binary(dat$timestamp_16[idxhr])
as.binary(dat$timestamp_16[idxhr])[1]
as.binary(dat$timestamp_16[idxhr])[1] - ( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[lastNonNA]]&as.binary(0xFFFF)) & as.binary(0xFFFF)
as.binary(dat$timestamp_16[idxhr])[1] - ( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF)) & as.binary(0xFFFF)
as.binary(dat$timestamp_16[idxhr])[1]
( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]
)
-( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]])
as.binary(dat$timestamp_16[idxhr])[[1]]-( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]])
as.binary(dat$timestamp_16[idxhr])[[1]]-( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]) & as.binary(0xFFFF)
as.binary(dat$timestamp_16[idxhr])[[1]]-( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]])
( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[lastNonNA]]&as.binary(0xFFFF))
( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
as.binary(dat$timestamp_16[idxhr])-(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
as.binary(dat$timestamp_16[idxhr])-(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]])
as.binary(dat$timestamp_16[idxhr])[[1]]-(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
dat$timestamp_16[idxhr][1]
as.binary(dat$timestamp_16[idxhr][1])
as.binary(dat$timestamp_16[idxhr][1])-(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF))
as.numeric(as.binary(dat$timestamp_16[idxhr][1])-(as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF)))
as.numeric((as.binary(dat$timestamp[!is.na(dat$timestamp)])[[1]]&as.binary(0xFFFF)))
dat
dat$timestamp
dat$timestamp[5]
as.binary(dat$timestamp[5])
dat
t16 = as.binary(dat$timestamp_16[6])
head(dat,10)
mesgTimestamp = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp = mesgTimestamp+(t16-(mesgTimestamp&as.binary(0xFFFF)))&as.binary(0xFFFF)
mesgTimestamp
as.numeric(mesgTimestamp)
?strptime
mesgTimestamp
as.numeric(mesgTimestamp)
as.numeric(t16)
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp = as.binary(dat$timestamp[5])
mesgTimestamp+t16
as.numeric(mesgTimestamp+t16)
as.numeric(mesgTimestamp)
as.POSIXct(c(as.numeric(mesgTimestamp),as.numeric(mesgTimestamp+t16)))
as.POSIXct(c(as.numeric(mesgTimestamp),as.numeric(mesgTimestamp+t16)),origin="1989-12-01")
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = mesgTimestamp+(t16-(mesgTimestamp&as.binary(0xFFFF)))&as.binary(0xFFFF)
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = (t16-(mesgTimestamp&as.binary(0xFFFF)))&as.binary(0xFFFF)
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = (t16-(mesgTimestamp&as.binary(0xFFFF)))
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = mesgTimestamp1+(t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF)
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp2 = (t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF)
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = mesgTimestamp1+(t16-(mesgTimestamp1&as.binary(0xFFFF)))
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
as.POSIXct((t16-(mesgTimestamp1&as.binary(0xFFFF))),origin="1989-12-01")
0xFFFF
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = mesgTimestamp1+(t16-(mesgTimestamp1&0xFFFF))&0xFFFF
mesgTimestamp1&0xFFFF)
class(0xFFFF)
t16
as.numeric(t16)
as.bumeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
mesgTimestamp1
as.numeric(mesgTimestamp1)
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
mesgTimestamp1
mesgTimestamp2
as.numeric(mesgTimestamp2)
as.POSIXct(as.numeric(mesgTimestamp2),origin = "1989-12-01")
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
dat$timestamp[5]
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
as.POSIXct(c(mesgTimestamp1,as.numeric(mesgTimestamp2)),origin="1989-12-01")
as.numeric(mesgTimestamp1)
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1970-01-01")
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
# ^ that returns t16, which makes sense if msgtime cancels...
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1970-01-01")
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp1+t16)),origin="1970-01-01")
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1970-01-01")
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1)&as.binary(0xFFFF)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1&as.binary(0xFFFF))+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1970-01-01")
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
mesgTimestamp1
as.numeric(mesgTimestamp1)
t16 = as.binary(dat$timestamp_16[6])
dat
setwd("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/")
# dir() # does return all the fit files...
# for each date in the data folder
dat=c()
dates = dir()
idx = 0
for(di in dates)
files = dir(paste("./",di,sep="")) # get .fit files
setwd(paste("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/",di,sep=""))
# for each file in the date directory
for (fi in files){
fi
idx = idx+1
tmpdat=read.fit(fi)$monitoring
cond=read.fit(fi)$monitoring$heart_rate
if(!is.null(cond)){
# fill in NAs for missing columns
dat[   setdiff(names(tmpdat), names(dat))]<- NA
tmpdat[setdiff(names(dat), names(tmpdat))]<- NA
# concatinate
dat=rbind(dat,tmpdat)
}
}
# get heart rate indecies
idxhr= !is.na(dat$heart_rate)
# garmin timestamp and timestamp_16 are mutually exclusive;
all(is.na(dat$timestamp[-1])==!is.na(dat$timestamp_16[-1]))
# ^ values that are NA in one are not NA in the other
# garmin time is seconds since Dec 31, 1989,
# to convert to standard unix time since 1970 epoch, add 631065600
# or just set origin accordingly;
#dat$timestamp=as.POSIXct(dat$timestamp,tz="UTC",origin="1989-12-01")
# works for the timestamps
# note a pattern here;
# dat$timestamp_16[idxhr]%%(64)
# note sure about the timestamp_16s?
# seconds in a day; (60*60*24)
# from; https://www.thisisant.com/forum/viewthread/6374
# for timestamp_16;
# Hi Philippe,
#
#It looks like we do not explain the usage of timestamp_16 in our documentation. We will look into adding an explanation for this in the future.
#
# timestamp_16 is a 16 bit version of the timestamp field (which is 32 bit) that represents the lower 16 bits of the timestamp. This field is meant to  be used in combination with an earlier timestamp field that is used as a reference for the upper 16 bits.
#
# The proper way to deal with this field is shown in MonitoringReader.java in the SDK and summarized as follows:
#
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
#
# Where the mesgTimestamp is the previous 32 bit timestamp (the "timestamp" field). This essentially swaps the lower 16 bits of the timestamp field with the timestamp_16 field, and deals with any rollovers that may occur.
# converts ints to bits
# last timestamp +
# intToBits(dat$timestamp) +
# intToBits(dat$timestamp_16[idxhr][1])
# maybe try replacing the last 16 bits of the timestamp with those from the timestamp_16?
# so something like
# library(binaryLogic)
# as.binary(dat$timestamp[!is.na(dat$timestamp)])
# porting the advice to R:
# mesgTimestamp = last non NA as.binary(dat$timestamp[!is.na(dat$timestamp)])
# +=
# as.binary(dat$timestamp_16[idxhr])
# - ( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[lastNonNA]]&as.binary(0xFFFF))
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[5])
t16 = as.binary(dat$timestamp_16[6])
mesgTimestamp2 = as.numeric(mesgTimestamp1)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1970-01-01")
# plot
plot(dat$timestamp_16[idxhr]/(60*60)+4,dat$heart_rate[idxhr],type='l',
xlab="Timestamp-16")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-01-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
t16
dat
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[70])
t16 = as.binary(dat$timestamp_16[71:76])
t16
mesgTimestamp2 = as.numeric(mesgTimestamp1)+as.numeric((t16-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF))
length(t16)
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[70])
t16 = as.binary(dat$timestamp_16[71:76])
mesgTimestamp2=c()
for(ti in 1:length(t16)){
mesgTimestamp2 = c(mesgTimestamp2,as.numeric(mesgTimestamp1)+as.numeric((t16[[ti]]-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF)))
}
mesgTimestamp2
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-01")
dat
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),as.numeric(as.binary(dat$timestamp_16[77]))),origin="1989-12-01")
dat$timestamp_16[77]
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),as.numeric(as.binary(dat$timestamp[77]))),origin="1989-12-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),as.numeric(as.binary(dat$timestamp[77:78]))),origin="1989-12-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),
as.numeric(as.binary(dat$timestamp[77])),
as.numeric(as.binary(dat$timestamp[78]))),origin="1989-12-01")
dat
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),
as.numeric(as.binary(dat$timestamp[77])),
as.numeric(as.binary(dat$timestamp[82]))),origin="1989-12-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),
as.numeric(as.binary(dat$timestamp[77])),
as.numeric(as.binary(dat$timestamp[82]))),origin="1989-13-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),
as.numeric(as.binary(dat$timestamp[77])),
as.numeric(as.binary(dat$timestamp[82]))),origin="1990-01-01")
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2),
as.numeric(as.binary(dat$timestamp[77])),
as.numeric(as.binary(dat$timestamp[82]))),origin="1989-12-31")
dat
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[28])
t16 = as.binary(dat$timestamp_16[29:61])
mesgTimestamp2=c()
for(ti in 1:length(t16)){
mesgTimestamp2 = c(mesgTimestamp2,as.numeric(mesgTimestamp1)+as.numeric((t16[[ti]]-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF)))
}
# ^ that returns t16, which makes sense if msgtime cancels...
# reset origin since this was done with original timestamp call
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-31")
dat[61,]
dat[50:61,]
setwd("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/")
# dir() # does return all the fit files...
# for each date in the data folder
dat=c()
dates = dir()
idx = 0
for(di in dates)
files = dir(paste("./",di,sep="")) # get .fit files
setwd(paste("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/",di,sep=""))
# for each file in the date directory
for (fi in files){
fi
idx = idx+1
tmpdat=read.fit(fi)$monitoring
cond=read.fit(fi)$monitoring$heart_rate
if(!is.null(cond)){
# fill in NAs for missing columns
dat[   setdiff(names(tmpdat), names(dat))]<- NA
tmpdat[setdiff(names(dat), names(tmpdat))]<- NA
# concatinate
dat=rbind(dat,tmpdat)
}
}
dat=dat[-1,]; # remove first row that is all NAs
# get heart rate indecies
idxhr= !is.na(dat$heart_rate)
# garmin timestamp and timestamp_16 are mutually exclusive;
all(is.na(dat$timestamp)==!is.na(dat$timestamp_16))
# ^ values that are NA in one are not NA in the other
head(dat)
which(is.na(timestamp_16))
which(is.na(dat$timestamp_16))
diff(which(is.na(dat$timestamp_16)))
mesgTimestamp1 = as.binary(dat$timestamp[28])
setwd("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/")
# dir() # does return all the fit files...
# for each date in the data folder
dat=c()
dates = dir()
idx = 0
for(di in dates)
files = dir(paste("./",di,sep="")) # get .fit files
setwd(paste("/Volumes/GoogleDrive/My Drive/CurrentDrive/LabWork/Project Fitness/Data/",di,sep=""))
# for each file in the date directory
for (fi in files){
fi
idx = idx+1
tmpdat=read.fit(fi)$monitoring
cond=read.fit(fi)$monitoring$heart_rate
if(!is.null(cond)){
# fill in NAs for missing columns
dat[   setdiff(names(tmpdat), names(dat))]<- NA
tmpdat[setdiff(names(dat), names(tmpdat))]<- NA
# concatinate
dat=rbind(dat,tmpdat)
}
}
dat=dat[-1,]; # remove first row that is all NAs
# get heart rate indecies
idxhr= !is.na(dat$heart_rate)
# garmin timestamp and timestamp_16 are mutually exclusive;
all(is.na(dat$timestamp)==!is.na(dat$timestamp_16))
# ^ values that are NA in one are not NA in the other
# garmin time is seconds since Dec 31, 1989,
# to convert to standard unix time since 1970 epoch, add 631065600
# or just set origin accordingly;
#dat$timestamp=as.POSIXct(dat$timestamp,tz="UTC",origin="1989-12-31")
# works for the timestamps
# note a pattern here;
# dat$timestamp_16[idxhr]%%(64)
# note sure about the timestamp_16s?
# seconds in a day; (60*60*24)
# from; https://www.thisisant.com/forum/viewthread/6374
# for timestamp_16;
# Hi Philippe,
#
#It looks like we do not explain the usage of timestamp_16 in our documentation. We will look into adding an explanation for this in the future.
#
# timestamp_16 is a 16 bit version of the timestamp field (which is 32 bit) that represents the lower 16 bits of the timestamp. This field is meant to  be used in combination with an earlier timestamp field that is used as a reference for the upper 16 bits.
#
# The proper way to deal with this field is shown in MonitoringReader.java in the SDK and summarized as follows:
#
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
#
# Where the mesgTimestamp is the previous 32 bit timestamp (the "timestamp" field). This essentially swaps the lower 16 bits of the timestamp field with the timestamp_16 field, and deals with any rollovers that may occur.
# converts ints to bits
# last timestamp +
# intToBits(dat$timestamp) +
# intToBits(dat$timestamp_16[idxhr][1])
# maybe try replacing the last 16 bits of the timestamp with those from the timestamp_16?
# so something like
# library(binaryLogic)
# as.binary(dat$timestamp[!is.na(dat$timestamp)])
# porting the advice to R:
# mesgTimestamp = last non NA as.binary(dat$timestamp[!is.na(dat$timestamp)])
# +=
# as.binary(dat$timestamp_16[idxhr])
# - ( as.binary(dat$timestamp[!is.na(dat$timestamp)])[[lastNonNA]]&as.binary(0xFFFF))
# e.g.
#  mesgTimestamp += ( timestamp_16 - ( mesgTimestamp & 0xFFFF ) ) & 0xFFFF;
mesgTimestamp1 = as.binary(dat$timestamp[28])
mesgTimestamp1 = as.binary(dat$timestamp[27])
t16 = as.binary(dat$timestamp_16[28:60])
mesgTimestamp2=c()
for(ti in 1:length(t16)){
mesgTimestamp2 = c(mesgTimestamp2,as.numeric(mesgTimestamp1)+as.numeric((t16[[ti]]-(mesgTimestamp1&as.binary(0xFFFF)))&as.binary(0xFFFF)))
}
as.POSIXct(c(as.numeric(mesgTimestamp1),as.numeric(mesgTimestamp2)),origin="1989-12-31")
ts = rep(NA,length(dat$timestamp_16)); # initialize vector for sensible timestamps
notna = which(!is.na(dat$timestamp))
ts[notna]=dat$timestamp[notna]
ts
dat$timestamp
# plot
plot(dat$timestamp_16[idxhr]/(60*60)+4,dat$heart_rate[idxhr],type='l',
xlab="Timestamp-16")
?as.binary
